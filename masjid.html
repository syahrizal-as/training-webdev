<!doctype html>
<html lang="id" data-bs-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CMS Pengurus Masjid â€” Demo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --brand:#2563eb; --brand-2:#1d4ed8; --ink:#0f172a; --muted:#64748b; --ring: 0 8px 30px rgba(2,6,23,.06);
}
body{ background: linear-gradient(180deg,#f8fafc,#ffffff 12%); }
.container-max{ max-width:1160px; }
.navbar{ backdrop-filter:saturate(1.1) blur(4px); }
.gradient-header{
  background:
    radial-gradient(900px 300px at 10% -20%, rgba(37,99,235,.18),transparent 50%),
    radial-gradient(900px 300px at 90% -30%, rgba(16,185,129,.18),transparent 45%),
    linear-gradient(180deg, rgba(2,6,23,.02), rgba(2,6,23,0));
}
.sidebar{
  width:280px;background:linear-gradient(180deg,#fff,#f8fafc);
  border:1px solid rgba(2,6,23,.05); border-radius:16px; box-shadow:var(--ring);
}
.sidebar .list-group-item{ border:0;padding:.85rem 1rem;font-weight:600;color:#374151; }
.sidebar .list-group-item i{ width:20px; }
.sidebar .list-group-item.active{
  color:var(--brand); background:linear-gradient(90deg, rgba(37,99,235,.12),transparent);
}
.card-kpi{ border:0; box-shadow: var(--ring); border-radius:18px; }
.card .card-header{ background:transparent; border-bottom:1px dashed rgba(2,6,23,.08); }
.brand-badge{ background:rgba(37,99,235,.12); color:#1e40af; }
.table-fit td,.table-fit th{ white-space:nowrap; }
.empty{ border:1px dashed #cbd5e1; border-radius:14px; padding:2rem; text-align:center; color:#64748b; }
.btn-ghost{ border:1px solid rgba(2,6,23,.08); background:#fff; }
.badge-soft-success{ background:rgba(34,197,94,.12); color:#166534; }
.badge-soft-danger{ background:rgba(239,68,68,.12); color:#7f1d1d; }
.fab{
  position:fixed; right:22px; bottom:22px; z-index:1080;
  border-radius:999px; padding:.9rem 1rem; box-shadow:0 10px 30px rgba(37,99,235,.35);
}
.form-soft{ border:1px solid rgba(2,6,23,.08)!important; }
.shadow-soft{ box-shadow:var(--ring); }
</style>
</head>
<body>
<!-- Topbar -->
<nav class="navbar bg-white sticky-top border-bottom">
  <div class="container-fluid container-max">
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-ghost d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#sideNav"><i class="bi bi-list"></i></button>
      <span class="fs-5 fw-semibold"><i class="bi bi-moon-stars me-2 text-primary"></i>CMS Pengurus Masjid</span>
      <span class="badge brand-badge d-none d-md-inline">Demo</span>
    </div>
    <div class="d-flex gap-2">
      <select id="activeMasjid" class="form-select form-select-sm form-soft"></select>
      <button id="btnSeed" class="btn btn-sm btn-outline-primary"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset Data</button>
      <button id="btnDark" class="btn btn-sm btn-outline-secondary" title="Dark/Light"><i class="bi bi-brightness-high"></i></button>
    </div>
  </div>
</nav>

<!-- Header -->
<div class="gradient-header py-4">
  <div class="container container-max">
    <h1 class="h4 mb-1" id="pageTitle">Dashboard</h1>
    <div class="text-secondary" id="pageSub">Ringkasan aktivitas & keuangan masjid</div>
  </div>
</div>

<!-- Layout -->
<div class="container container-max mt-3">
  <div class="row g-3">
    <div class="col-lg-3">
      <div class="offcanvas-lg offcanvas-start sidebar p-0" id="sideNav">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Navigasi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
          <div class="list-group list-group-flush" id="menu">
            <a data-page="dashboard" class="list-group-item list-group-item-action active"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
            <a data-page="masjid" class="list-group-item list-group-item-action"><i class="bi bi-buildings me-2"></i>Masjid</a>
            <a data-page="pengurus" class="list-group-item list-group-item-action"><i class="bi bi-people me-2"></i>Pengurus & Jabatan</a>
            <a data-page="kas" class="list-group-item list-group-item-action"><i class="bi bi-cash-coin me-2"></i>Kas</a>
            <a data-page="aset" class="list-group-item list-group-item-action"><i class="bi bi-box-seam me-2"></i>Aset</a>
            <a data-page="wilayah" class="list-group-item list-group-item-action"><i class="bi bi-geo-alt me-2"></i>Wilayah</a>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-9" id="content"></div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 2000">
  <div id="appToast" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg">Tersimpan!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script>
/* ===== Utils & Storage ===== */
const $$  = (s,el=document)=>el.querySelector(s);
const $$$ = (s,el=document)=>[...el.querySelectorAll(s)];
const fmtIDR = n => (Number(n)||0).toLocaleString('id-ID');
const today = () => new Date().toISOString().slice(0,10);
const uid = () => crypto.randomUUID();
const KEY='cms_masjid_demo_v3';
let db = JSON.parse(localStorage.getItem(KEY) || 'null');
if(!db){ db = seed(); save(); }
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); refreshMasjidSelector(); }
function toast(msg='Tersimpan!', success=true){
  const t=$$('#appToast'); const body=$$('#toastMsg');
  t.classList.toggle('text-bg-success',success);
  t.classList.toggle('text-bg-danger',!success);
  body.textContent=msg; bootstrap.Toast.getOrCreateInstance(t).show();
}

/* ===== Seed Demo Data ===== */
function seed(){
  const kab=[{id:1,name:'Tangerang'},{id:2,name:'Bekasi'}];
  const kec=[{id:1,name:'Ciputat',kabupaten_id:1},{id:2,name:'Pondok Aren',kabupaten_id:1},{id:3,name:'Pondok Gede',kabupaten_id:2}];
  const kel=[{id:1,name:'Cipayung',kecamatan_id:1},{id:2,name:'Pondok Kacang',kecamatan_id:2},{id:3,name:'Jatiwaringin',kecamatan_id:3}];
  const masjid=[
    {id:1,name:'Masjid Al-Falah',alamat:'Jl. Mawar No.12',kecamatan_id:1,kelurahan_id:1,image:''},
    {id:2,name:'Masjid Al-Muhajirin',alamat:'Jl. Melati No.7',kecamatan_id:2,kelurahan_id:2,image:''}
  ];
  const jabatan=[
    {id:1,name:'Ketua DKM',type:'Struktural'},
    {id:2,name:'Bendahara',type:'Struktural'},
    {id:3,name:'Sekretaris',type:'Struktural'},
    {id:4,name:'Imam',type:'Religius'},
    {id:5,name:'Muadzin',type:'Religius'},
  ];
  const users=[
    {id:1,nik:'320101001',nama:'Ust. Ahmad',email:'ahmad@gmail.com',phone:'0812345678',image:'',masjid_id:1,kecamatan_id:1,kelurahan_id:1},
    {id:2,nik:'320101002',nama:'Pak Ridwan',email:'ridwan@gmail.com',phone:'0812987654',image:'',masjid_id:1,kecamatan_id:1,kelurahan_id:1},
    {id:3,nik:'320102003',nama:'Pak Yusuf',email:'yusuf@gmail.com',phone:'0822114455',image:'',masjid_id:2,kecamatan_id:2,kelurahan_id:2},
  ];
  const user_jabatan=[
    {user_id:1,jabatan_id:1},
    {user_id:2,jabatan_id:2},
    {user_id:3,jabatan_id:4},
  ];
  const kas=[
    {id:uid(),masjid_id:1,nominal:5000000,keterangan:'Donasi Jumat',tanggal:'2025-10-15',type:'pemasukan'},
    {id:uid(),masjid_id:1,nominal:2000000,keterangan:'Pembelian Karpet',tanggal:'2025-10-20',type:'pengeluaran'},
    {id:uid(),masjid_id:1,nominal:1200000,keterangan:'Kotak Infaq',tanggal:'2025-10-28',type:'pemasukan'},
    {id:uid(),masjid_id:2,nominal:3500000,keterangan:'Sumbangan Warga',tanggal:'2025-10-25',type:'pemasukan'},
    {id:uid(),masjid_id:2,nominal:900000,keterangan:'Perawatan AC',tanggal:'2025-10-27',type:'pengeluaran'},
    {id:uid(),masjid_id:1,nominal:1800000,keterangan:'Donasi Harian',tanggal:'2025-11-02',type:'pemasukan'},
    {id:uid(),masjid_id:1,nominal:450000,keterangan:'Konsumsi Pengajian',tanggal:'2025-11-03',type:'pengeluaran'},
  ];
  const assets=[
    {id:uid(),masjid_id:1,name:'Sound System'},
    {id:uid(),masjid_id:1,name:'Karpet'},
    {id:uid(),masjid_id:2,name:'Mimbar Kayu'},
  ];
  return {kab,kec,kel,masjid,jabatan,users,user_jabatan,kas,assets, activeMasjid:1};
}

/* ===== Theme + Nav ===== */
let currentPage='dashboard';
function refreshMasjidSelector(){
  const sel=$$('#activeMasjid'); if(!sel) return;
  sel.innerHTML = db.masjid.map(m=>`<option value="${m.id}" ${m.id==db.activeMasjid?'selected':''}>${m.name}</option>`).join('');
  $$('#pageSub').textContent = `Aktif: ${db.masjid.find(x=>x.id==db.activeMasjid)?.name||'-'}`;
}
$$('#btnSeed').addEventListener('click', ()=>{ if(confirm('Reset demo data ke kondisi awal?')){ db = seed(); save(); render(currentPage); toast('Data direset.'); }});
$$('#btnDark').addEventListener('click', ()=>{
  const root=document.documentElement;
  const theme = root.getAttribute('data-bs-theme')==='dark' ? 'light' : 'dark';
  root.setAttribute('data-bs-theme', theme);
});
$$$('#menu a').forEach(a=>{
  a.addEventListener('click', ()=>{
    $$('#menu a.active')?.classList.remove('active'); a.classList.add('active');
    render(a.dataset.page); bootstrap.Offcanvas.getInstance('#sideNav')?.hide();
  });
});
document.addEventListener('change', e=>{
  if(e.target.id==='activeMasjid'){ db.activeMasjid = Number(e.target.value); save(); render(currentPage); }
});

/* ===== Helpers (UI) ===== */
const selectKec = (name='kecamatan_id', val='') =>
  `<select name="${name}" class="form-select form-soft">${db.kec.map(k=>`<option value="${k.id}" ${k.id==val?'selected':''}>${k.name}</option>`).join('')}</select>`;
const selectKel = (name='kelurahan_id', val='') =>
  `<select name="${name}" class="form-select form-soft">${db.kel.map(k=>`<option value="${k.id}" ${k.id==val?'selected':''}>${k.name}</option>`).join('')}</select>`;

/* ===== Render Pages ===== */
function render(page){
  currentPage=page; const el=$$('#content'); const mID=db.activeMasjid;
  $$('#pageTitle').textContent =
    page==='dashboard' ? 'Dashboard' :
    page==='masjid' ? 'Manajemen Masjid' :
    page==='pengurus' ? 'Pengurus & Jabatan' :
    page==='kas' ? 'Transaksi Kas' :
    page==='aset' ? 'Aset Masjid' : 'Master Wilayah';

  if(page==='dashboard'){ el.innerHTML=viewDashboard(mID); mountDashboard(); return; }
  if(page==='masjid'){ el.innerHTML=viewMasjid(); mountMasjid(); return; }
  if(page==='pengurus'){ el.innerHTML=viewPengurus(mID); mountPengurus(); return; }
  if(page==='kas'){ el.innerHTML=viewKas(mID); mountKas(); return; }
  if(page==='aset'){ el.innerHTML=viewAset(mID); mountAset(); return; }
  if(page==='wilayah'){ el.innerHTML=viewWilayah(); mountWilayah(); return; }
}

/* ---------- Dashboard ---------- */
function calcSaldo(mID){
  return db.kas.filter(k=>k.masjid_id===mID).reduce((t,k)=> t + (k.type==='pemasukan'?+k.nominal:-k.nominal),0);
}
function viewDashboard(mID){
  const saldo = calcSaldo(mID);
  const totalPengurus = db.users.filter(u=>u.masjid_id===mID).length;
  const totalAset = db.assets.filter(a=>a.masjid_id===mID).length;
  return `
  <div class="row g-3">
    <div class="col-md-4">
      <div class="card card-kpi">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div><div class="text-secondary small">Saldo Kas</div><div class="fs-4 fw-bold">Rp ${fmtIDR(saldo)}</div></div>
          <i class="bi bi-wallet2 fs-1 text-success"></i>
        </div>
      </div>
    </div>
    <div class="col-md-4"><div class="card card-kpi"><div class="card-body d-flex justify-content-between align-items-center">
      <div><div class="text-secondary small">Pengurus Aktif</div><div class="fs-4 fw-bold">${totalPengurus}</div></div>
      <i class="bi bi-people fs-1 text-primary"></i></div></div></div>
    <div class="col-md-4"><div class="card card-kpi"><div class="card-body d-flex justify-content-between align-items-center">
      <div><div class="text-secondary small">Total Aset</div><div class="fs-4 fw-bold">${totalAset}</div></div>
      <i class="bi bi-box-seam fs-1 text-warning"></i></div></div></div>

    <div class="col-12">
      <div class="card card-kpi">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Grafik Kas Bulanan</h6>
            <div class="d-flex gap-2">
              <input type="month" id="monthFilter" class="form-control form-control-sm form-soft" value="${new Date().toISOString().slice(0,7)}">
              <button class="btn btn-sm btn-outline-secondary" id="exportCSV"><i class="bi bi-filetype-csv me-1"></i>Export</button>
            </div>
          </div>
          <canvas id="chartKas" height="110"></canvas>
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card card-kpi">
        <div class="card-body">
          <h6 class="mb-3">Transaksi Terbaru</h6>
          ${sectionTransaksi(mID)}
        </div>
      </div>
    </div>
  </div>`;
}
function sectionTransaksi(mID){
  const rows=db.kas.filter(k=>k.masjid_id===mID).sort((a,b)=>b.tanggal.localeCompare(a.tanggal)).slice(0,8);
  if(!rows.length) return `<div class="empty"><i class="bi bi-inboxes me-2"></i>Belum ada transaksi.</div>`;
  return `<div class="table-responsive">
    <table class="table table-striped align-middle table-fit">
      <thead><tr><th>Tanggal</th><th>Jenis</th><th>Keterangan</th><th class="text-end">Nominal</th></tr></thead>
      <tbody>${rows.map(k=>`
        <tr>
          <td>${k.tanggal}</td>
          <td><span class="badge ${k.type==='pemasukan'?'badge-soft-success':'badge-soft-danger'}">${k.type}</span></td>
          <td>${k.keterangan}</td>
          <td class="text-end">Rp ${fmtIDR(k.nominal)}</td>
        </tr>`).join('')}
      </tbody>
    </table>
  </div>`;
}
function mountDashboard(){
  const mID=db.activeMasjid; const ym=$$('#monthFilter').value||new Date().toISOString().slice(0,7);
  const rows=db.kas.filter(k=>k.masjid_id===mID && k.tanggal.startsWith(ym));
  const days=[...new Set(rows.map(r=>r.tanggal.slice(8,10)))].sort();
  const pemasukan=days.map(d=> rows.filter(r=>r.tanggal.slice(8,10)===d && r.type==='pemasukan').reduce((a,b)=>a+Number(b.nominal),0));
  const pengeluaran=days.map(d=> rows.filter(r=>r.tanggal.slice(8,10)===d && r.type==='pengeluaran').reduce((a,b)=>a+Number(b.nominal),0));
  if(window._chartKas) window._chartKas.destroy();
  window._chartKas=new Chart($$('#chartKas'),{
    type:'bar',
    data:{ labels: days.map(d=>`${ym}-${d}`), datasets:[{label:'Pemasukan',data:pemasukan},{label:'Pengeluaran',data:pengeluaran}]},
    options:{ responsive:true, scales:{y:{beginAtZero:true}} }
  });
  $$('#monthFilter').onchange = mountDashboard;
  $$('#exportCSV').onclick=()=>{
    const rows=db.kas.filter(k=>k.masjid_id===mID).map(k=>[k.tanggal,k.type,k.keterangan,k.nominal]);
    const csv='Tanggal,Jenis,Keterangan,Nominal\n'+rows.map(r=>r.join(',')).join('\n');
    const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); const a=document.createElement('a'); a.href=url; a.download='kas.csv'; a.click(); URL.revokeObjectURL(url);
  };
}

/* ---------- Masjid ---------- */
function viewMasjid(){
  return `
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Manajemen Masjid</h5>
    <button class="btn btn-primary" id="btnAddMasjid"><i class="bi bi-plus-lg me-1"></i>Masjid</button>
  </div>
  <div class="card card-kpi">
    <div class="card-body">
      <input id="searchMasjid" class="form-control form-soft mb-3" placeholder="Cari nama/alamat...">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light"><tr><th>Nama</th><th>Alamat</th><th>Wilayah</th><th style="width:120px"></th></tr></thead>
          <tbody id="tblMasjid"></tbody>
        </table>
      </div>
    </div>
  </div>
  ${modalMasjid()}`;
}
function modalMasjid(){
  return `
  <div class="modal fade" id="modalMasjid" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formMasjid">
          <div class="modal-header"><h5 class="modal-title">Masjid</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <input type="hidden" name="id">
            <div class="mb-2"><label class="form-label">Nama</label><input name="name" class="form-control form-soft" required></div>
            <div class="mb-2"><label class="form-label">Alamat</label><input name="alamat" class="form-control form-soft"></div>
            <div class="row g-2">
              <div class="col-6"><label class="form-label">Kecamatan</label>${selectKec()}</div>
              <div class="col-6"><label class="form-label">Kelurahan</label>${selectKel()}</div>
            </div>
          </div>
          <div class="modal-footer"><button class="btn btn-primary" type="submit">Simpan</button></div>
        </form>
      </div>
    </div>
  </div>`;
}
function mountMasjid(){
  const tb=$$('#tblMasjid'), q=$$('#searchMasjid');
  const draw=()=>{
    const kw=(q.value||'').toLowerCase();
    const rows=db.masjid.filter(m=>`${m.name} ${m.alamat}`.toLowerCase().includes(kw));
    tb.innerHTML = rows.map(m=>{
      const kec=db.kec.find(k=>k.id==m.kecamatan_id)?.name||'-';
      const kel=db.kel.find(k=>k.id==m.kelurahan_id)?.name||'-';
      return `<tr>
        <td class="fw-semibold">${m.name}</td>
        <td>${m.alamat||'-'}</td>
        <td><span class="badge text-bg-light">${kec} / ${kel}</span></td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-edit="${m.id}"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-del="${m.id}"><i class="bi bi-trash"></i></button>
        </td></tr>`;
    }).join('') || `<tr><td colspan="4"><div class="empty">Belum ada masjid.</div></td></tr>`;
  }; draw();

  $$('#btnAddMasjid').onclick=()=>{ $$('#formMasjid').reset(); $$('[name=id]').value=''; bootstrap.Modal.getOrCreateInstance('#modalMasjid').show(); };
  tb.addEventListener('click',e=>{
    const id=e.target.closest('button')?.dataset.edit; const del=e.target.closest('button')?.dataset.del;
    if(id){ const m=db.masjid.find(x=>x.id==id); for(const k in m){ const f=$$(`#formMasjid [name=${k}]`); if(f) f.value=m[k]; } bootstrap.Modal.getOrCreateInstance('#modalMasjid').show(); }
    if(del && confirm('Hapus masjid ini?')){ db.masjid=db.masjid.filter(x=>x.id!=del); if(db.activeMasjid==del) db.activeMasjid=db.masjid[0]?.id||1; save(); draw(); refreshMasjidSelector(); toast('Masjid dihapus.'); }
  });
  q.oninput=draw;

  $$('#formMasjid').onsubmit=e=>{
    e.preventDefault();
    const v=Object.fromEntries(new FormData(e.target).entries());
    v.id = v.id? Number(v.id) : (Math.max(0,...db.masjid.map(x=>x.id))+1);
    v.kecamatan_id=Number(v.kecamatan_id); v.kelurahan_id=Number(v.kelurahan_id);
    const idx=db.masjid.findIndex(x=>x.id==v.id);
    if(idx>-1) db.masjid[idx]=v; else db.masjid.push(v);
    save(); draw(); refreshMasjidSelector(); bootstrap.Modal.getInstance('#modalMasjid').hide(); toast('Masjid tersimpan.');
  };
}

/* ---------- Pengurus ---------- */
function viewPengurus(mID){
  const jabOps = db.jabatan.map(j=>`<option value="${j.id}">${j.name} (${j.type})</option>`).join('');
  return `
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Pengurus & Jabatan</h5>
    <button class="btn btn-primary" id="btnAddUser"><i class="bi bi-plus-lg me-1"></i>Pengurus</button>
  </div>
  <div class="card card-kpi">
    <div class="card-body">
      <div class="row g-2 mb-3">
        <div class="col-md-8"><input id="searchUser" class="form-control form-soft" placeholder="Cari nama/email/HP"></div>
        <div class="col-md-4"><select id="filterJabatan" class="form-select form-soft"><option value="">Semua Jabatan</option>${db.jabatan.map(j=>`<option value="${j.id}">${j.name}</option>`).join('')}</select></div>
      </div>
      <div class="table-responsive"><table class="table align-middle table-fit">
        <thead class="table-light"><tr><th>Nama</th><th>Kontak</th><th>Jabatan</th><th style="width:140px"></th></tr></thead>
        <tbody id="tblUser"></tbody></table></div>
    </div>
  </div>

  <div class="modal fade" id="modalUser" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <form id="formUser">
      <div class="modal-header"><h5 class="modal-title">Pengurus</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" name="id">
        <div class="row g-2">
          <div class="col-7"><label class="form-label">Nama</label><input name="nama" class="form-control form-soft" required></div>
          <div class="col-5"><label class="form-label">NIK</label><input name="nik" class="form-control form-soft"></div>
          <div class="col-6"><label class="form-label">Email</label><input name="email" type="email" class="form-control form-soft"></div>
          <div class="col-6"><label class="form-label">No. HP</label><input name="phone" class="form-control form-soft"></div>
          <div class="col-6"><label class="form-label">Kecamatan</label>${selectKec('kecamatan_id')}</div>
          <div class="col-6"><label class="form-label">Kelurahan</label>${selectKel('kelurahan_id')}</div>
          <div class="col-12"><label class="form-label">Jabatan</label>
            <select multiple name="jabatan_ids" class="form-select form-soft" size="5">${jabOps}</select>
            <div class="form-text">Cmd/Ctrl untuk multi pilih.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-primary" type="submit">Simpan</button></div>
    </form></div></div></div>`;
}
function mountPengurus(){
  const mID=db.activeMasjid, tb=$$('#tblUser'), q=$$('#searchUser'), fj=$$('#filterJabatan');
  const mapJabatan = uid => db.user_jabatan.filter(uj=>uj.user_id==uid).map(uj=>db.jabatan.find(j=>j.id==uj.jabatan_id)?.name).filter(Boolean).join(', ');
  const draw=()=>{
    const kw=(q.value||'').toLowerCase(), fil=fj.value;
    const rows=db.users.filter(u=>u.masjid_id===mID && (`${u.nama} ${u.email} ${u.phone}`.toLowerCase().includes(kw))).filter(u=>!fil || db.user_jabatan.some(uj=>uj.user_id==u.id && uj.jabatan_id==fil));
    tb.innerHTML = rows.map(u=>`
      <tr>
        <td class="fw-semibold">${u.nama}</td>
        <td><div>${u.email||'-'}</div><div class="text-muted small">${u.phone||'-'}</div></td>
        <td>${mapJabatan(u.id)||'-'}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-edit="${u.id}"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-del="${u.id}"><i class="bi bi-trash"></i></button>
        </td>
      </tr>`).join('') || `<tr><td colspan="4"><div class="empty">Belum ada pengurus.</div></td></tr>`;
  }; draw();

  $$('#btnAddUser').onclick=()=>{ $$('#formUser').reset(); $$('[name=id]').value=''; bootstrap.Modal.getOrCreateInstance('#modalUser').show(); };
  tb.addEventListener('click',e=>{
    const id=e.target.closest('button')?.dataset.edit; const del=e.target.closest('button')?.dataset.del;
    if(id){
      const u=db.users.find(x=>x.id==id);
      ['id','nik','nama','email','phone','kecamatan_id','kelurahan_id'].forEach(k=>{$$(`#formUser [name=${k}]`).value=u[k]??'';});
      const owned=db.user_jabatan.filter(uj=>uj.user_id==u.id).map(uj=>String(uj.jabatan_id));
      $$$('#formUser [name="jabatan_ids"] option').forEach(o=>o.selected=owned.includes(o.value));
      bootstrap.Modal.getOrCreateInstance('#modalUser').show();
    }
    if(del && confirm('Hapus pengurus ini?')){ db.users=db.users.filter(x=>x.id!=del); db.user_jabatan=db.user_jabatan.filter(uj=>uj.user_id!=del); save(); draw(); toast('Pengurus dihapus.'); }
  });
  q.oninput=draw; fj.onchange=draw;

  $$('#formUser').onsubmit=e=>{
    e.preventDefault();
    const f=new FormData(e.target); const v=Object.fromEntries(f.entries());
    const id = v.id? Number(v.id) : (Math.max(0,...db.users.map(x=>x.id))+1);
    const u = { id, nik:v.nik||'', nama:v.nama, email:v.email||'', phone:v.phone||'', image:'', masjid_id:mID, kecamatan_id:Number(v.kecamatan_id), kelurahan_id:Number(v.kelurahan_id) };
    const idx=db.users.findIndex(x=>x.id==id); if(idx>-1) db.users[idx]=u; else db.users.push(u);
    const selected=[...$$$('#formUser [name="jabatan_ids"] option')].filter(o=>o.selected).map(o=>Number(o.value));
    db.user_jabatan = db.user_jabatan.filter(uj=>uj.user_id!=id).concat(selected.map(jid=>({user_id:id,jabatan_id:jid})));
    save(); draw(); bootstrap.Modal.getInstance('#modalUser').hide(); toast('Pengurus tersimpan.');
  };
}

/* ---------- Kas ---------- */
function viewKas(mID){
  return `
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Transaksi Kas</h5>
    <div class="text-end">
      <div class="text-secondary small">Saldo Saat Ini</div>
      <div class="fs-5 fw-bold">Rp ${fmtIDR(calcSaldo(mID))}</div>
    </div>
  </div>
  <div class="card card-kpi">
    <div class="card-body">
      <div class="row g-2 mb-3">
        <div class="col-sm-4"><input type="month" id="kasMonth" class="form-control form-soft"></div>
        <div class="col-sm-6"><input type="text" id="kasSearch" class="form-control form-soft" placeholder="Cari keterangan..."></div>
        <div class="col-sm-2 d-grid"><button class="btn btn-outline-secondary" id="kasReset">Reset</button></div>
      </div>
      <div class="table-responsive">
        <table class="table align-middle table-fit">
          <thead class="table-light"><tr><th>Tanggal</th><th>Jenis</th><th>Keterangan</th><th class="text-end">Nominal</th><th style="width:120px"></th></tr></thead>
          <tbody id="tblKas"></tbody>
        </table>
      </div>
    </div>
  </div>
  ${modalKas()}
  <button class="btn btn-primary fab" id="btnAddKas"><i class="bi bi-plus-lg me-1"></i>Transaksi</button>`;
}
function modalKas(){
  return `
  <div class="modal fade" id="modalKas" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <form id="formKas">
      <div class="modal-header"><h5 class="modal-title">Transaksi Kas</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" name="id">
        <div class="row g-2">
          <div class="col-6"><label class="form-label">Tanggal</label><input type="date" name="tanggal" value="${today()}" class="form-control form-soft" required></div>
          <div class="col-6"><label class="form-label">Jenis</label><select name="type" class="form-select form-soft" required><option value="pemasukan">Pemasukan</option><option value="pengeluaran">Pengeluaran</option></select></div>
          <div class="col-12"><label class="form-label">Keterangan</label><input name="keterangan" class="form-control form-soft" required></div>
          <div class="col-12"><label class="form-label">Nominal (Rp)</label><input name="nominal" type="number" min="0" class="form-control form-soft" required></div>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-primary" type="submit">Simpan</button></div>
    </form></div></div></div>`;
}
function mountKas(){
  const mID=db.activeMasjid, tb=$$('#tblKas'), mon=$$('#kasMonth'), q=$$('#kasSearch'), rs=$$('#kasReset');
  const draw=()=>{
    const ym=(mon.value||'').trim(); const kw=(q.value||'').toLowerCase();
    const rows=db.kas.filter(k=>k.masjid_id===mID).filter(k=>!ym || k.tanggal.startsWith(ym)).filter(k=>k.keterangan.toLowerCase().includes(kw)).sort((a,b)=>b.tanggal.localeCompare(a.tanggal));
    tb.innerHTML = rows.map(k=>`
      <tr>
        <td>${k.tanggal}</td>
        <td><span class="badge ${k.type==='pemasukan'?'badge-soft-success':'badge-soft-danger'}">${k.type}</span></td>
        <td>${k.keterangan}</td>
        <td class="text-end">Rp ${fmtIDR(k.nominal)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-edit="${k.id}"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-del="${k.id}"><i class="bi bi-trash"></i></button>
        </td></tr>`).join('') || `<tr><td colspan="5"><div class="empty">Belum ada transaksi.</div></td></tr>`;
  }; draw();

  $$('#btnAddKas').onclick=()=>{ $$('#formKas').reset(); $$('[name="tanggal"]').value=today(); $$('[name=id]').value=''; bootstrap.Modal.getOrCreateInstance('#modalKas').show(); };
  tb.addEventListener('click',e=>{
    const id=e.target.closest('button')?.dataset.edit; const del=e.target.closest('button')?.dataset.del;
    if(id){ const k=db.kas.find(x=>x.id==id); ['id','tanggal','type','keterangan','nominal'].forEach(n=>$$(`#formKas [name=${n}]`).value=k[n]); bootstrap.Modal.getOrCreateInstance('#modalKas').show(); }
    if(del && confirm('Hapus transaksi?')){ db.kas=db.kas.filter(x=>x.id!=del); save(); draw(); toast('Transaksi dihapus.'); render('dashboard'); }
  });
  mon.onchange=draw; q.oninput=draw; rs.onclick=()=>{ mon.value=''; q.value=''; draw(); };

  $$('#formKas').onsubmit=e=>{
    e.preventDefault();
    const v=Object.fromEntries(new FormData(e.target).entries());
    const row={ id: v.id||uid(), masjid_id:mID, tanggal:v.tanggal, type:v.type, keterangan:v.keterangan, nominal:Number(v.nominal) };
    const idx=db.kas.findIndex(x=>x.id==row.id); if(idx>-1) db.kas[idx]=row; else db.kas.push(row);
    save(); draw(); render('dashboard'); bootstrap.Modal.getInstance('#modalKas').hide(); toast('Transaksi tersimpan.');
  };
}

/* ---------- Aset ---------- */
function viewAset(mID){
  return `
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Aset Masjid</h5>
    <button class="btn btn-primary" id="btnAddAset"><i class="bi bi-plus-lg me-1"></i>Aset</button>
  </div>
  <div class="card card-kpi"><div class="card-body">
    <div class="table-responsive"><table class="table align-middle">
      <thead class="table-light"><tr><th>Nama Aset</th><th style="width:120px"></th></tr></thead>
      <tbody id="tblAset"></tbody></table></div>
  </div></div>
  ${modalAset()}`;
}
function modalAset(){
  return `<div class="modal fade" id="modalAset" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <form id="formAset"><div class="modal-header"><h5 class="modal-title">Aset</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><input type="hidden" name="id"><label class="form-label">Nama Aset</label><input name="name" class="form-control form-soft" required></div>
      <div class="modal-footer"><button class="btn btn-primary" type="submit">Simpan</button></div>
    </form></div></div></div>`;
}
function mountAset(){
  const mID=db.activeMasjid, tb=$$('#tblAset'); const draw=()=>{
    tb.innerHTML = db.assets.filter(a=>a.masjid_id===mID).map(a=>`
      <tr><td>${a.name}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-edit="${a.id}"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-del="${a.id}"><i class="bi bi-trash"></i></button>
      </td></tr>`).join('') || `<tr><td colspan="2"><div class="empty">Belum ada aset.</div></td></tr>`;
  }; draw();
  $$('#btnAddAset').onclick=()=>{ $$('#formAset').reset(); $$('[name=id]').value=''; bootstrap.Modal.getOrCreateInstance('#modalAset').show(); };
  tb.addEventListener('click',e=>{
    const id=e.target.closest('button')?.dataset.edit; const del=e.target.closest('button')?.dataset.del;
    if(id){ const a=db.assets.find(x=>x.id==id); $$('[name=id]').value=a.id; $$('[name=name]').value=a.name; bootstrap.Modal.getOrCreateInstance('#modalAset').show(); }
    if(del && confirm('Hapus aset?')){ db.assets=db.assets.filter(x=>x.id!=del); save(); draw(); toast('Aset dihapus.'); }
  });
  $$('#formAset').onsubmit=e=>{
    e.preventDefault();
    const v=Object.fromEntries(new FormData(e.target).entries());
    const row={ id: v.id||uid(), masjid_id:mID, name:v.name };
    const idx=db.assets.findIndex(x=>x.id==row.id); if(idx>-1) db.assets[idx]=row; else db.assets.push(row);
    save(); draw(); bootstrap.Modal.getInstance('#modalAset').hide(); toast('Aset tersimpan.');
  };
}

/* ---------- Wilayah ---------- */
function viewWilayah(){
  return `
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Master Wilayah</h5>
    <div class="btn-group">
      <button class="btn btn-outline-primary btn-sm" id="btnAddKab">Kabupaten</button>
      <button class="btn btn-outline-primary btn-sm" id="btnAddKec">Kecamatan</button>
      <button class="btn btn-outline-primary btn-sm" id="btnAddKel">Kelurahan</button>
    </div>
  </div>
  <div class="row g-3">
    <div class="col-md-4"><div class="card card-kpi"><div class="card-header">Kabupaten/Kota</div><div class="card-body" id="tblKab"></div></div></div>
    <div class="col-md-4"><div class="card card-kpi"><div class="card-header">Kecamatan</div><div class="card-body" id="tblKec"></div></div></div>
    <div class="col-md-4"><div class="card card-kpi"><div class="card-header">Kelurahan</div><div class="card-body" id="tblKel"></div></div></div>
  </div>
  ${modalSimple('modalAddKab','Tambah Kabupaten',['name'])}
  ${modalSimple('modalAddKec','Tambah Kecamatan',['name','kabupaten_id'],'Kabupaten')}
  ${modalSimple('modalAddKel','Tambah Kelurahan',['name','kecamatan_id'],'Kecamatan')}`;
}
function modalSimple(id,title,fields,relTitle=''){
  const rel = relTitle?`<div class="mb-2"><label class="form-label">${relTitle}</label>${
    relTitle==='Kabupaten'?`<select name="kabupaten_id" class="form-select form-soft">${db.kab.map(k=>`<option value="${k.id}">${k.name}</option>`).join('')}</select>`:
    `<select name="kecamatan_id" class="form-select form-soft">${db.kec.map(k=>`<option value="${k.id}">${k.name}</option>`).join('')}</select>`
  }</div>`:'';
  return `<div class="modal fade" id="${id}" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <form data-id="${id}"><div class="modal-header"><h5 class="modal-title">${title}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        ${fields.map(f=>`<div class="mb-2"><label class="form-label text-capitalize">${f.replace('_',' ')}</label><input name="${f}" class="form-control form-soft" required></div>`).join('')}
        ${rel}
      </div>
      <div class="modal-footer"><button class="btn btn-primary" type="submit">Simpan</button></div>
    </form></div></div></div>`;
}
function renderListKab(){ return `<ul class="list-group list-group-flush">${db.kab.map(k=>`<li class="list-group-item d-flex justify-content-between align-items-center">${k.name}<button class="btn btn-sm btn-outline-danger" data-del-kab="${k.id}"><i class="bi bi-trash"></i></button></li>`).join('')}</ul>`;}
function renderListKec(){ return `<ul class="list-group list-group-flush">${db.kec.map(k=>`<li class="list-group-item d-flex justify-content-between align-items-center">${k.name}<span class="badge text-bg-light">${db.kab.find(x=>x.id==k.kabupaten_id)?.name||'-'}</span><button class="btn btn-sm btn-outline-danger" data-del-kec="${k.id}"><i class="bi bi-trash"></i></button></li>`).join('')}</ul>`;}
function renderListKel(){ return `<ul class="list-group list-group-flush">${db.kel.map(k=>`<li class="list-group-item d-flex justify-content-between align-items-center">${k.name}<span class="badge text-bg-light">${db.kec.find(x=>x.id==k.kecamatan_id)?.name||'-'}</span><button class="btn btn-sm btn-outline-danger" data-del-kel="${k.id}"><i class="bi bi-trash"></i></button></li>`).join('')}</ul>`;}
function mountWilayah(){
  $$('#tblKab').innerHTML=renderListKab();
  $$('#tblKec').innerHTML=renderListKec();
  $$('#tblKel').innerHTML=renderListKel();
  $$('#btnAddKab').onclick=()=>bootstrap.Modal.getOrCreateInstance('#modalAddKab').show();
  $$('#btnAddKec').onclick=()=>bootstrap.Modal.getOrCreateInstance('#modalAddKec').show();
  $$('#btnAddKel').onclick=()=>bootstrap.Modal.getOrCreateInstance('#modalAddKel').show();
  document.querySelectorAll('form[data-id]').forEach(f=>{
    f.onsubmit=e=>{
      e.preventDefault(); const id=f.getAttribute('data-id'); const d=Object.fromEntries(new FormData(f).entries());
      if(id==='modalAddKab'){ db.kab.push({id:Math.max(0,...db.kab.map(k=>k.id))+1,name:d.name}); }
      if(id==='modalAddKec'){ db.kec.push({id:Math.max(0,...db.kec.map(k=>k.id))+1,name:d.name,kabupaten_id:Number(d.kabupaten_id)}); }
      if(id==='modalAddKel'){ db.kel.push({id:Math.max(0,...db.kel.map(k=>k.id))+1,name:d.name,kecamatan_id:Number(d.kecamatan_id)}); }
      save(); mountWilayah(); bootstrap.Modal.getInstance('#'+id).hide(); f.reset(); toast('Wilayah tersimpan.');
    };
  });
  $$('#tblKab').onclick=e=>{const id=e.target.closest('button')?.dataset.delKab; if(id && confirm('Hapus kabupaten?')){ db.kab=db.kab.filter(k=>k.id!=id); save(); mountWilayah(); }};
  $$('#tblKec').onclick=e=>{const id=e.target.closest('button')?.dataset.delKec; if(id && confirm('Hapus kecamatan?')){ db.kec=db.kec.filter(k=>k.id!=id); save(); mountWilayah(); }};
  $$('#tblKel').onclick=e=>{const id=e.target.closest('button')?.dataset.delKel; if(id && confirm('Hapus kelurahan?')){ db.kel=db.kel.filter(k=>k.id!=id); save(); mountWilayah(); }};
}

/* ===== INIT ===== */
render('dashboard');
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
